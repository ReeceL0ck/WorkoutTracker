<!-- index.html -->
{% extends 'base.html' %}
{% block content %}
{% load static %}
<h2>{{ page_title }}</h2> 
<!DOCTYPE html>
<meta charset="utf-8">

<!-- Load d3.js and CSS -->
<script src="https://d3js.org/d3.v4.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>

<link rel="stylesheet" type="text/css" href="{% static 'tracker/style.css' %}">


<!-- Create a div where the graph will take place -->
<div id="graph-container" class="graph-container"></div>

<script>

const data = {{ graph_data | safe }};

data.forEach(d => {
    d.date = new Date(d.x); 
    d.weight = d.y;  
    d.no_of_reps = d.z
    
    console.log(d.date, d.weight, d.no_of_reps);
    console.log(d.y);
    

});
function getMax(arr, prop) {
    var max;
    for (var i=0 ; i<arr.length ; i++) {
        if (max == null || parseInt(arr[i][prop]) > parseInt(max[prop]))
            max = arr[i];
    }
    return max;
}
var maxPpg = getMax(data, "y");
console.log('Max weight:', maxPpg.y);
console.log('Exercise data:', data); 


// set the dimensions and margins of the graph
var margin = {top: 10, right: 20, bottom: 40, left: 50},
    width = 1000 - margin.left - margin.right,
    height = 420 - margin.top - margin.bottom;
    title = "Weight Progression Over Time"; 

// append the svg object to the body of the page
var svg = d3.select("#graph-container")
  .append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")  
    .attr("transform",
          "translate(" + margin.left + "," + margin.top + ")");

// Add X axis
var x = d3.scaleTime()
    .domain([new Date(2025, 0, 1), new Date(2025, 12, 1)])
    .range([0, width]);
svg.append("g")
    .attr("transform", "translate(0," + height + ")")
    .call(d3.axisBottom(x));
svg.append("g")
    .attr("transform", "translate(0," + height + ")")
    .call(d3.axisBottom(x));

// Add Y axis
var y = d3.scaleLinear()
    .domain([0,  maxPpg.y + 10])
    .range([ height, 0]);
svg.append("g")
    .call(d3.axisLeft(y));

// Add a scale for bubble size
var z = d3.scaleLinear()
    .domain([0, 20])
    .range([3 , 40]);

var myColor = d3.scaleOrdinal()
    .domain([0,20])
    .range(d3.schemeSet2);

var tooltip = d3.select("#graph-container")
    .append("div")
        .style("opacity", 0)
        .style("position", "absolute")
        .attr("class", "tooltip")
        .style("background-color", "black")
        .style("border-radius", "5px")
        .style("padding", "10px")
        .style("color", "white");

// -2- Create 3 functions to show / update (when mouse move but stay on same circle) / hide the tooltip
var showTooltip = function(d) {
    tooltip
        .transition()
        .duration(200)

    tooltip
        .style("opacity", 1)
        // .style("border", "1px solid black")
        .html("Reps: " + d.no_of_reps + "<br>Weight: " + d.weight + "kg")
        .style("left", (d3.event.pageX + 10) + "px")
        .style("top", (d3.event.pageY + 10) + "px")
}
var moveTooltip = function(d) {

    tooltip
        .style("left", (d3.event.pageX + 10) + "px")
        .style("top", (d3.event.pageY + 10) + "px")
}
var hideTooltip = function(d) {
    tooltip
        .transition()
        .duration(200)
        .style("opacity", 0)
}
// Add X axis label:
svg.append("text")
    .attr("text-anchor", "end")
    .attr("x", width/2 + margin.left)
    .attr("y", height + margin.top + 25)
    .text("Date");

// Y axis label:
svg.append("text")
    .attr("text-anchor", "end")
    .attr("transform", "rotate(-90)")
    .attr("y", -margin.left + 15)
    .attr("x", -margin.top - height/2 +50)
    .text("Weight (kg)")

// Add dots
svg.append('g')
    .selectAll("dot")
    .data(data)
    .enter()    
    .append("circle")
        .attr("class", "bubbles")
        .attr("cx", function (d) { return x(d.date); } )
        .attr("cy", function (d) { return y(d.weight); } )
        .attr("r", function (d) { return z(d.no_of_reps); } )
        // .style("fill", "#568be1")
        .style("fill", function (d) { return myColor(d.no_of_reps); } )
        .style("cursor", "pointer")
        .style("opacity", "0.7")
        .attr("stroke", "white")
    .on("mouseover", showTooltip )
    .on("mousemove", moveTooltip )
    .on("mouseleave", hideTooltip )

</script>
{% endblock %}  